<div class="chat-area ai-theme theme-red-white h-100 d-flex flex-column">
  <!-- Error message snackbar -->
  <div class="error-snackbar" *ngIf="errorMessage">
    <div class="error-content">
      <i class="material-icons">error</i>
      <span>{{ errorMessage }}</span>
    </div>
  </div>

  <!-- <div class="suggestions" *ngIf="dynamicSuggestions.length === 0">
    <div class="suggestion" *ngFor="let question of initialQuestions" (click)="selectSuggestion(question)">
      {{ question }}
    </div>
  </div>  -->

  <!-- <div class="suggestions" *ngIf="dynamicSuggestions.length > 0">
    <div class="suggestion" *ngFor="let question of dynamicSuggestions" (click)="selectSuggestion(question)">
      {{ question }}
    </div>
  </div> -->

  <div class="chat-messages flex-grow-1">
    <!-- Welcome robot -->
    <!-- <div class="message bot-message welcome-message">
      <div class="robot-container">
        <div class="robot">
          <div class="robot-head">
            <div class="robot-face">
              <div class="robot-eye left-eye"></div>
              <div class="robot-eye right-eye"></div>
              <div class="robot-mouth"></div>
            </div>
            <div class="robot-antenna"></div>
          </div>
          <div class="robot-body">
            <div class="robot-detail"></div>
          </div>
        </div>
        <div class="tooltip-side" *ngIf="showTooltip">
          Hello! How can I assist you today?
        </div>
      </div>
    </div> -->

    <!-- messages -->
    <ng-container *ngFor="let message of messages; let i = index">
      <div class="message" [class.user-message]="message.sender === 'user'"
        [class.bot-message]="message.sender === 'bot'">
        <!-- FILE tile -->
        <div *ngIf="message.type === 'file'" class="file-message">
          <div class="file-info">
            <i class="material-icons">description</i>
            <div class="file-details">
              <span class="file-name">{{ message.fileName }}</span>
              <span class="file-size">{{ message.fileSize }}</span>
            </div>

            <div class="file-status" [class.valid]="message.isValid === true"
              [class.invalid]="message.isValid === false"
              [class.processing]="message.isProcessing || message.uploading">

              <div class="status-content">
                <div class="processing-spinner" *ngIf="message.uploading || message.isProcessing">
                  <div class="spinner"></div>
                </div>

                <i class="material-icons" *ngIf="message.isValid === true">check_circle</i>
                <i class="material-icons"
                  *ngIf="message.isValid === false && !(message.uploading || message.isProcessing)">error</i>

                <span>
                  <!-- upload/validate status text -->
                  <ng-container *ngIf="message.uploading">Uploading...</ng-container>
                  <ng-container *ngIf="!message.uploading && message.isProcessing">Validating...</ng-container>
                  <ng-container
                    *ngIf="!message.uploading && !message.isProcessing && message.isValid === true">Valid</ng-container>
                  <ng-container
                    *ngIf="!message.uploading && !message.isProcessing && message.isValid === false">Invalid</ng-container>
                  <ng-container
                    *ngIf="!message.uploading && !message.isProcessing && message.isValid === null && message.uploaded">Uploaded</ng-container>
                </span>
              </div>
            </div>
          </div>

          <div *ngIf="message.validationResult" class="validation-result">
            {{ message.validationResult }}
          </div>
        </div>

        <!-- Typing indicator -->
        <div *ngIf="message.typing" class="typing-indicator">
          <span></span><span></span><span></span>
        </div>

        <!-- Text -->
        <div *ngIf="!message.typing && message.type !== 'file'" class="message-content"
          [innerHTML]="formatMessage(message.text, message.is_html)" (click)="handleHtmlClick($event)">
        </div>

        <div *ngIf="message.sender === 'bot' && i === messages.length -1" class="action-buttons">

          <button class="icon-button speak" (click)="speak(message.text)" *ngIf="showVolume">
            <i class="material-icons">volume_up</i>
          </button>

          <button class="icon-button stop" (click)="stop()" *ngIf="!showVolume">
            <i class="material-icons">volume_off</i>
          </button>

        </div>


        <!-- Actions -->
        <div *ngIf="message.actions && message.sender === 'bot'" class="action-buttons">
          <button *ngFor="let action of message.actions" class="action-button"
            (click)="handleAction(action.action, message.text)">
            {{ action.text }}
          </button>
        </div>
        <div *ngIf="message.hasErrors" class="download-button">
          <button (click)="downloadFileWithErrors(message.fileName)" class="action-button">
            <i class="material-icons">download</i> Download File with Error Highlights
          </button>
        </div>

        <!-- In the file message section -->
        <!-- <div *ngIf="message.hasErrors" class="download-button">
  <button (click)="downloadFileWithErrors(message.fileName)" class="action-button">
    <i class="material-icons">download</i> Download with Errors
  </button>
</div> -->
        <div class="message-time">{{ getCurrentTime() }}</div>
      </div>
    </ng-container>
  </div>
  <!-- Uploaded files panel -->
  <div class="uploaded-files-panel" *ngIf="uploadedFiles.length > 0">
    <div class="panel-header">
      <span>Uploaded Files</span>
      <button class="clear-btn" (click)="clearFiles()">
        <i class="material-icons">clear_all</i>
      </button>
    </div>
    <div class="files-list">
      <div *ngFor="let file of uploadedFiles" class="file-item">
        <i class="material-icons">description</i>
        <span class="file-name">{{ file.name }}</span>
        <span class="file-size">{{ formatFileSize(file.size) }}</span>
        <button class="remove-btn" (click)="removeFile(file)">
          <i class="material-icons">close</i>
        </button>
      </div>
    </div>
  </div>
  <!-- Suggestions (just above input) -->
  <div class="suggestions" *ngIf="dynamicSuggestions.length > 0">
    <div class="suggestion"
    *ngFor="let question of dynamicSuggestions"
    (click)="selectSuggestion(question)">
      {{ question }}
    </div>
  </div>

  <!-- Chat input -->
  <div class="chat-input">
    <!-- File upload -->
    <label class="file-upload-btn" [class.has-file]="uploadedFiles.length > 0">
      <i class="material-icons">{{ uploadedFiles.length > 0 ? 'attachment' : 'attach_file' }}</i>
      <input #fileInput type="file" class="file-input" (change)="uploadFile($event)" accept=".csv,.xlsx,.xls" multiple
        [disabled]="isWaitingForBot">
      <span class="file-count" *ngIf="uploadedFiles.length > 0">{{ uploadedFiles.length }}</span>
    </label>

    <!-- Mic -->
    <button class="mic-button" (click)="onStartListening()" *ngIf="!isListening && !isProcessingSpeech"
      [disabled]="isWaitingForBot">
      <i class="material-icons">mic</i>
    </button>

    <!-- Processing speech dots -->
    <div class="processing-indicator" *ngIf="isProcessingSpeech && !isListening">
      <div class="processing-dots">
        <span></span><span></span><span></span>
      </div>
    </div>

    <!-- Stop listening -->
    <button class="stop-button" (click)="onStopListening()" *ngIf="isListening">
      <i class="material-icons">stop</i>
    </button>

    <input [(ngModel)]="userInput" placeholder="Type your message..." (keyup)="onTyping()" (keyup.enter)="sendMessage()"
      [disabled]="isWaitingForBot">

    <button class="send-button" (click)="sendMessage()" [disabled]="isWaitingForBot || !userInput.trim()">
      <i class="material-icons">send</i>
    </button>
    <!-- <button class="btn-test" (click)="sendDummyResponse()">ðŸ’¡ Test Call Agent Response</button> -->
  </div>


</div>

<!-- voice -->
<!-- voice-recording.component.html -->
<div class="voice-recording-overlay" *ngIf="showVoiceAnim">
  <div class="recording-container">
    <div class="pulse-circle">
      <i class="material-icons">mic</i>
    </div>

    <div class="sound-waves">
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
    </div>

    <p class="listening-text">Listening... Speak now</p>

    <button class="stop-button" (click)="onStopListening()">
      Stop Listening
    </button>
  </div>
</div>
